name: ARTHEN Language CI/CD Pipeline

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run tests daily at 2 AM UTC
    - cron: '0 2 * * *'

env:
  PYTHON_VERSION: '3.9'
  NODE_VERSION: '18'
  ARTHEN_VERSION: '2.0.0'
  ARTHEN_TEST_MODE: 'true'
  HF_HUB_OFFLINE: '1'
  TRANSFORMERS_OFFLINE: '1'
  PYTHONHASHSEED: '0'
  OMP_NUM_THREADS: '1'

jobs:
  # Code Quality and Linting
  code-quality:
    name: Code Quality & Linting
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Cache Python Dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt', '**/test_requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort mypy bandit safety
        pip install -r tests/test_requirements.txt
        
    - name: Code Formatting Check (Black)
      run: black --check --diff .
      
    - name: Import Sorting Check (isort)
      run: isort --check-only --diff .
      
    - name: Linting (Flake8)
      run: flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
      
    - name: Type Checking (MyPy)
      run: mypy compiler/ stdlib/ --ignore-missing-imports
      
    - name: Security Analysis (Bandit)
      run: bandit -r compiler/ stdlib/ -f json -o bandit-report.json
      
    - name: Dependency Security Check (Safety)
      run: safety check --json --output safety-report.json
      
    - name: Upload Security Reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-reports
        path: |
          bandit-report.json
          safety-report.json

  # Unit Tests
  unit-tests:
    name: Unit Tests
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.8', '3.9', '3.10', '3.11']
        
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: Cache Python Dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-${{ matrix.python-version }}-pip-${{ hashFiles('**/test_requirements.txt') }}
        
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r tests/test_requirements.txt
        
    - name: Run Unit Tests
      run: |
        python tests/test_runner.py --categories unit --parallel
        
    - name: Upload Test Results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: unit-test-results-${{ matrix.os }}-${{ matrix.python-version }}
        path: tests/reports/

  # Integration Tests
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [code-quality]
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r tests/test_requirements.txt
        
    - name: Run Integration Tests
      run: |
        python tests/test_runner.py --categories integration
        
    - name: Upload Integration Test Results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: integration-test-results
        path: tests/reports/

  # AI/ML Tests
  ai-ml-tests:
    name: AI/ML Tests
    runs-on: ubuntu-latest
    needs: [unit-tests]
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r tests/test_requirements.txt
        
    - name: Run AI/ML Tests
      run: |
        python tests/test_runner.py --categories ai
        
    - name: Upload AI Test Results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: ai-test-results
        path: tests/reports/

  # Blockchain Tests
  blockchain-tests:
    name: Blockchain Tests
    runs-on: ubuntu-latest
    needs: [unit-tests]
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: Install Blockchain Dependencies
      run: |
        npm install -g ganache-cli truffle
        python -m pip install --upgrade pip
        pip install -r tests/test_requirements.txt
        
    - name: Start Test Blockchain
      run: |
        ganache-cli --deterministic --accounts 10 --host 0.0.0.0 --port 8545 &
        sleep 10
        
    - name: Run Blockchain Tests
      run: |
        python tests/test_runner.py --categories blockchain
        
    - name: Upload Blockchain Test Results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: blockchain-test-results
        path: tests/reports/

  # Performance Tests
  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: [integration-tests]
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r tests/test_requirements.txt
        
    - name: Run Performance Tests
      run: |
        python tests/test_runner.py --categories performance --performance
        
    - name: Upload Performance Results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: performance-test-results
        path: tests/reports/

  # Security Tests
  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest
    needs: [code-quality]
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r tests/test_requirements.txt
        
    - name: Run Security Tests
      run: |
        python tests/test_runner.py --categories security --security
        
    - name: Upload Security Test Results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-test-results
        path: tests/reports/

  # Comprehensive Test Suite
  comprehensive-tests:
    name: Comprehensive Test Suite
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, ai-ml-tests, blockchain-tests]
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: Install All Dependencies
      run: |
        npm install -g ganache-cli truffle
        python -m pip install --upgrade pip
        pip install -r tests/test_requirements.txt
        
    - name: Start Test Environment
      run: |
        ganache-cli --deterministic --accounts 10 --host 0.0.0.0 --port 8545 &
        sleep 10
        
    - name: Run Comprehensive Test Suite
      run: |
        python tests/test_runner.py --parallel --performance --security
        
    - name: Generate Coverage Report
      run: |
        coverage combine
        coverage report --show-missing
        coverage html
        
    - name: Upload Comprehensive Results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: comprehensive-test-results
        path: |
          tests/reports/
          tests/htmlcov/
          
    - name: Upload Coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./tests/reports/coverage.xml
        flags: unittests
        name: codecov-umbrella

  # Build and Package
  build-package:
    name: Build & Package
    runs-on: ubuntu-latest
    needs: [comprehensive-tests]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install Build Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine wheel setuptools
        
    - name: Build Package
      run: |
        python -m build
        
    - name: Check Package
      run: |
        twine check dist/*
        
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: python-package
        path: dist/

  # Deploy Documentation
  deploy-docs:
    name: Deploy Documentation
    runs-on: ubuntu-latest
    needs: [comprehensive-tests]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install Documentation Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install sphinx sphinx-rtd-theme myst-parser
        
    - name: Build Documentation
      run: |
        cd docs
        make html
        
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs/_build/html

  # Release
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-package]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && contains(github.event.head_commit.message, '[release]')
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Download Build Artifacts
      uses: actions/download-artifact@v3
      with:
        name: python-package
        path: dist/
        
    - name: Create Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ env.ARTHEN_VERSION }}
        release_name: ARTHEN Language v${{ env.ARTHEN_VERSION }}
        body: |
          ## ARTHEN Native Language v${{ env.ARTHEN_VERSION }}
          
          ### Features
          - AI-Optimized Syntax for blockchain development
          - ML-Driven Consensus mechanisms
          - Cross-platform blockchain compilation
          - Comprehensive AI/ML integration
          
          ### Changes
          - See commit history for detailed changes
          
          ### Installation
          ```bash
          pip install arthen-lang==${{ env.ARTHEN_VERSION }}
          ```
        draft: false
        prerelease: false

  # Notification
  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [comprehensive-tests]
    if: always()
    
    steps:
    - name: Notify Success
      if: needs.comprehensive-tests.result == 'success'
      run: |
        echo "✅ ARTHEN Language CI/CD Pipeline completed successfully!"
        
    - name: Notify Failure
      if: needs.comprehensive-tests.result == 'failure'
      run: |
        echo "❌ ARTHEN Language CI/CD Pipeline failed!"
        exit 1